---
interface Props {
  labels: string[];
  values: number[][];
}

const { labels, values } = Astro.props;

const cellStyle = (value: number, diagonal: boolean): string => {
  const capped = Math.max(0, Math.min(100, value));
  const alpha = diagonal
    ? 0.18 + (capped / 100) * 0.62
    : 0.06 + (capped / 100) * 0.5;

  const [r, g, b] = diagonal ? [76, 175, 80] : [212, 130, 42];
  return `background-color: rgba(${r}, ${g}, ${b}, ${alpha.toFixed(3)});`;
};

const cellTextClass = (value: number, diagonal: boolean): string => {
  if (diagonal || value >= 60) {
    return "text-white font-semibold";
  }
  return "text-zinc-800 dark:text-zinc-100";
};
---

<div class="not-prose full-bleed px-6">
  <div class="mx-auto max-w-[70rem] overflow-x-auto rounded-xl border border-zinc-300 bg-[#FAF6F0] p-4 dark:border-zinc-700 dark:bg-zinc-900">
    <table class="w-full min-w-[42rem] border-collapse text-center text-sm">
      <caption class="mb-3 text-left text-base font-semibold text-zinc-900 dark:text-zinc-100">
        Classification confusion matrix (%)
      </caption>
      <thead>
        <tr>
          <th class="sticky left-0 bg-[#FAF6F0] px-2 py-2 text-left font-semibold text-zinc-900 dark:bg-zinc-900 dark:text-zinc-100">
            Actual \\ Pred
          </th>
          {
            labels.map((label) => (
              <th class="px-2 py-2 font-semibold text-zinc-900 dark:text-zinc-100">
                {label}
              </th>
            ))
          }
        </tr>
      </thead>
      <tbody>
        {
          values.map((row, rowIndex) => (
            <tr>
              <th class="sticky left-0 border-t border-zinc-200 bg-[#FAF6F0] px-2 py-2 text-left font-semibold text-zinc-900 dark:border-zinc-700 dark:bg-zinc-900 dark:text-zinc-100">
                {labels[rowIndex]}
              </th>
              {
                row.map((value, colIndex) => {
                  const diagonal = rowIndex === colIndex;
                  return (
                    <td
                      class={`border border-white/40 px-2 py-2 dark:border-zinc-800 ${cellTextClass(value, diagonal)}`}
                      style={cellStyle(value, diagonal)}
                    >
                      {value}
                    </td>
                  );
                })
              }
            </tr>
          ))
        }
      </tbody>
    </table>

    <div class="mt-3 flex flex-wrap items-center gap-4 text-xs text-zinc-700 dark:text-zinc-200">
      <div class="flex items-center gap-2">
        <span class="h-3 w-3 rounded-sm bg-[rgba(76,175,80,0.75)]"></span>
        <span>Diagonal (correct classification)</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="h-3 w-3 rounded-sm bg-[rgba(212,130,42,0.5)]"></span>
        <span>Off-diagonal confusion</span>
      </div>
    </div>
  </div>
</div>
